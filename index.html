<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow a Garden</title>
<style>
  /* Reset e base */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  html {
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    min-height: 100%;
    color: #1e293b;
    user-select: none;
  }
  body {
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    align-items: center;
    justify-content: center;
  }
  header {
    background: rgba(255 255 255 / 0.85);
    backdrop-filter: saturate(180%) blur(20px);
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    padding: 1rem 2rem;
    font-weight: 700;
    font-size: 1.5rem;
    color: #0f172a;
    text-align: center;
    width: 100%;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  #start-screen, #login-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: rgba(255, 255, 255, 0.95);
    position: relative;
    padding: 20px;
  }
  #start-screen img {
    width: 300px;
    height: auto;
    margin-bottom: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    border-radius: 24px;
  }
  #start-button, #login-button {
    background: #00bcd4;
    border: none;
    color: white;
    font-weight: 700;
    padding: 14px 28px;
    border-radius: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    font-size: 1.2rem;
    box-shadow: 0 6px 15px rgba(0,188,212,0.5);
    width: 220px;
  }
  #start-button:hover, #login-button:hover {
    background: #0097a7;
    box-shadow: 0 8px 20px rgba(0,151,167,0.7);
  }
  #login-screen {
    display: none;
  }
  #login-screen label {
    font-weight: 600;
    margin-top: 14px;
    font-size: 1rem;
    color: #084c61;
  }
  #login-screen input, #login-screen select {
    margin: 8px 0 20px 0;
    padding: 14px;
    border-radius: 12px;
    border: 1.5px solid #00bcd4;
    width: 260px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  #login-screen input:focus, #login-screen select:focus {
    border-color: #0097a7;
    outline: none;
    box-shadow: 0 0 8px #00bcd4aa;
  }
  /* Container do jogo inicialmente escondido */
  #game-container {
    margin-top: 1rem;
    background: rgba(255 255 255 / 0.95);
    border-radius: 24px;
    box-shadow: 0 16px 48px rgba(0,0,0,0.15);
    width: 1400px;
    max-width: 95vw;
    padding: 24px;
    display: none; /* inicialmente escondido */
    gap: 32px;
    position: relative;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }
  #garden-canvas {
    background: #77b255; /* Chão verde */
    border-radius: 16px;
    display: block;
    box-shadow: inset 0 8px 16px #4b772c;
    flex: 1 1 1024px;
    max-width: 1024px;
    height: 640px;
  }
  #info-panel {
    max-width: 320px;
    font-weight: 600;
    color: #05445e;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    background: #e0f7fa;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,108,134,0.15);
  }
  #info-panel h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.8rem;
    color: #007c91;
    text-align: center;
  }
  #coin-count {
    font-size: 1.8rem;
    margin-bottom: 1rem;
    text-align: center;
    color: #00647e;
    font-weight: 700;
  }
  .btn {
    background: #00bcd4;
    border: none;
    color: white;
    font-weight: 700;
    padding: 14px 24px;
    border-radius: 16px;
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    font-size: 1.1rem;
    box-shadow: 0 6px 16px rgba(0,188,212,0.5);
    width: 100%;
  }
  .btn:disabled {
    background: #81d4fa;
    box-shadow: none;
    cursor: not-allowed;
  }
  .btn:hover:not(:disabled) {
    background: #0097a7;
    box-shadow: 0 8px 24px rgba(0,151,167,0.7);
  }
  #inventory {
    background: #ffffff;
    border-radius: 16px;
    padding: 16px;
    height: 180px;
    overflow-y: auto;
    box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.05);
  }
  #inventory h3 {
    margin: 0 0 12px 0;
    font-weight: 700;
    color: #007c91;
    font-size: 1.2rem;
    text-align: center;
  }
  #inventory-list {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }
  .inventory-item {
    background: #00bcd4;
    border-radius: 14px;
    padding: 8px 14px;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: default;
    user-select: none;
    font-size: 1rem;
    box-shadow: 0 4px 10px rgba(0,188,212,0.4);
    transition: background-color 0.3s ease;
  }
  .inventory-item:hover {
    background: #0097a7;
  }
  
  /* Estilo para loja de frutas */
  #shop-modal-fruits {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255 255 255 / 0.98);
    border-radius: 24px;
    box-shadow: 0 16px 48px rgba(0,0,0,0.25);
    width: 500px;
    max-width: 90vw;
    padding: 24px;
    z-index: 100;
    display: none;
    flex-direction: column;
    font-family: 'Inter', sans-serif;
    max-height: 80vh;
  }
  
  #shop-modal-fruits h3 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    text-align: center;
    color: #007c91;
    font-size: 2rem;
    font-weight: 700;
    border-bottom: 3px solid #00bcd4;
    padding-bottom: 8px;
  }
  
  #shop-list-fruits {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    overflow-y: auto;
    flex: 1;
  }
  
  .fruit-item {
    background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
    border-radius: 16px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: white;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0, 151, 167, 0.3);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
  }
  
  .fruit-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 151, 167, 0.4);
  }
  
  .fruit-icon {
    font-size: 2rem;
    margin-right: 12px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .fruit-details {
    flex: 1;
  }
  
  .fruit-name {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 4px;
  }
  
  .fruit-rarity {
    font-size: 0.85rem;
    opacity: 0.9;
  }
  
  .fruit-price {
    font-size: 1.3rem;
    font-weight: 800;
    background: rgba(255, 255, 255, 0.2);
    padding: 8px 12px;
    border-radius: 12px;
    min-width: 100px;
    text-align: center;
  }
  
  .rarity-common {
    color: #4ade80;
  }
  
  .rarity-rare {
    color: #60a5fa;
  }
  
  .rarity-epic {
    color: #a78bfa;
  }
  
  .rarity-legendary {
    color: #f59e0b;
  }
  
  .rarity-mythic {
    color: #f43f5e;
  }

  /* Lojinha de sementes */
  #shop-modal-seeds {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255 255 255 / 0.98);
    border-radius: 24px;
    box-shadow: 0 16px 48px rgba(0,0,0,0.25);
    width: 500px;
    max-width: 90vw;
    padding: 24px;
    z-index: 100;
    display: none;
    flex-direction: column;
    font-family: 'Inter', sans-serif;
    max-height: 80vh;
  }
  
  #shop-modal-seeds h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    text-align: center;
    color: #007c91;
    font-size: 2rem;
    font-weight: 700;
    border-bottom: 3px solid #00bcd4;
    padding-bottom: 8px;
  }
  
  #shop-reset-timer {
    background: rgba(0, 188, 212, 0.1);
    padding: 8px;
    border-radius: 12px;
    margin: 0 auto 16px auto;
    width: 80%;
    text-align: center;
    font-weight: 600;
    color: #007c91;
  }
  
  #reset-time {
    font-weight: 800;
    color: #e74c3c;
    background: rgba(255, 255, 255, 0.9);
    padding: 4px 8px;
    border-radius: 8px;
    margin-left: 4px;
  }
  
  #shop-list-seeds {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    overflow-y: auto;
    flex: 1;
  }
  
  .seed-item {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 16px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    color: #0c4a6e;
    box-shadow: 0 4px 12px rgba(0, 151, 167, 0.1);
    border: 1px solid #bae6fd;
  }
  
  .seed-header {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .seed-icon {
    font-size: 1.8rem;
  }
  
  .seed-name {
    font-size: 1.2rem;
    font-weight: 700;
    flex: 1;
  }
  
  .seed-rarity {
    font-size: 0.9rem;
    padding: 4px 8px;
    border-radius: 8px;
    font-weight: 600;
  }
  
  .rarity-common-bg {
    background-color: #dcfce7;
    color: #166534;
  }
  
  .rarity-rare-bg {
    background-color: #dbeafe;
    color: #1e40af;
  }
  
  .rarity-epic-bg {
    background-color: #ede9fe;
    color: #5b21b6;
  }
  
  .rarity-legendary-bg {
    background-color: #fef3c7;
    color: #92400e;
  }
  
  .rarity-mythic-bg {
    background-color: #fee2e2;
    color: #991b1b;
  }
  
  .seed-desc {
    font-size: 0.95rem;
    color: #475569;
    margin-bottom: 8px;
  }
  
  .seed-buy-btn {
    background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
    border: none;
    color: white;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .seed-buy-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 151, 167, 0.3);
  }
  
  .seed-buy-btn:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Botão fechar loja */
  #shop-close-btn-fruits, #shop-close-btn-seeds {
    background: #e74c3c;
    padding: 16px;
    border-radius: 18px;
    color: white;
    font-weight: 700;
    border: none;
    cursor: pointer;
    align-self: center;
    margin-top: 16px;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    width: 180px;
    font-size: 1.2rem;
    box-shadow: 0 8px 24px rgba(231,76,60,0.85);
  }
  #shop-close-btn-fruits:hover, #shop-close-btn-seeds:hover {
    background: #c0392b;
    box-shadow: 0 12px 36px rgba(192,57,43,0.85);
  }

  /* Info vendedores simplificado */
  #seller-info-fruits, #seller-info-seeds, #seller-info-pet {
    background: #fff;
    border-radius: 16px;
    padding: 16px 20px;
    font-weight: 700;
    color: #006064;
    box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 350px;
    margin: 12px;
    user-select: none;
    font-size: 1rem;
  }
  #seller-info-fruits img, #seller-info-seeds img, #seller-info-pet img {
    width: 64px;
    height: 64px;
    border-radius: 20px;
    object-fit: contain;
    box-shadow: 0 4px 10px rgba(0, 188, 212, 0.4);
  }
  #seller-info-fruits span, #seller-info-seeds span, #seller-info-pet span {
    flex: 1;
    color: #007c91;
  }

  /* Variant indicators */
  .variant-indicator {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
  }
  
  .golden-variant {
    background: #ffd700;
  }
  
  .silver-variant {
    background: #c0c0c0;
  }
  
  .crystal-variant {
    background: #00bcd4;
  }

  /* NOVOS ESTILOS PARA BOTÕES MOBILE */
  #mobile-controls {
    position: fixed;
    bottom: 20px;
    left: 0;
    right: 0;
    display: none;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 20px;
    margin: 0 10px;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
    z-index: 100;
  }

  .mobile-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: #00bcd4;
    color: white;
    font-size: 24px;
    font-weight: bold;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0, 188, 212, 0.5);
    transition: all 0.2s ease;
    touch-action: manipulation;
  }

  .mobile-btn:active {
    transform: scale(0.95);
    background: #0097a7;
    box-shadow: 0 2px 5px rgba(0, 151, 167, 0.5);
  }

  .mobile-btn.action-btn {
    width: 120px;
    border-radius: 35px;
    font-size: 16px;
  }

  #mobile-direction-pad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 5px;
  }

  #btn-up { grid-column: 2; grid-row: 1; }
  #btn-left { grid-column: 1; grid-row: 2; }
  #btn-down { grid-column: 2; grid-row: 3; }
  #btn-right { grid-column: 3; grid-row: 2; }

  #mobile-action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  @media (max-width: 768px) {
    #mobile-controls {
      display: flex;
    }
    
    #game-container {
      padding-bottom: 120px; /* Espaço para os botões mobile */
    }
  }

  /* Responsive adjustments */
  @media (max-width: 1200px) {
    #game-container {
      flex-direction: column;
      align-items: center;
      padding: 16px;
      width: 100vw;
      max-width: 100vw;
    }
    #garden-canvas {
      max-width: 90vw;
      width: 90vw;
      height: calc(90vw * 5 / 8);
    }
    #info-panel {
      max-width: 90vw;
      width: 90vw;
      margin-top: 24px;
    }
    #seller-info-fruits, #seller-info-seeds, #seller-info-pet {
      max-width: 90vw;
      margin: 10px auto;
    }
    #shop-modal-fruits, #shop-modal-seeds {
      width: 90vw;
      max-width: 100vw;
      top: 10px;
      right: 5vw;
      padding: 18px 20px;
    }
    #shop-close-btn-fruits, #shop-close-btn-seeds {
      width: 100%;
      font-size: 1.1rem;
      margin-top: 12px;
    }
  }
</style>
</head>
<body>
<div id="start-screen" aria-label="Tela inicial">
  <img src="https://noping.com/_next/image?url=https%3A%2F%2Fblogadmin.noping.com%2Fwp-content%2Fuploads%2F2025%2F05%2Fgrowagarden-1747688567733.jpg&amp;w=1920&amp;q=75" alt="Grow a Garden Logo" />
  <button id="start-button" aria-label="Iniciar jogo">Iniciar Jogo</button>
</div>

<div id="login-screen" aria-label="Tela de login">
  <h2>Login do Jogador</h2>
  <input type="text" id="username" placeholder="Nome" aria-required="true" aria-label="Nome" />
  <input type="password" id="password" placeholder="Senha" aria-required="true" aria-label="Senha" />
  <label for="gender">Gênero:</label>
  <select id="gender" aria-label="Seleção de gênero">
    <option value="masculino">Masculino</option>
    <option value="feminino">Feminino</option>
  </select>
  <button id="login-button" aria-label="Entrar no jogo">Entrar</button>
</div>

<div id="game-container" role="main" aria-label="Área do jogo" aria-hidden="true">
  <canvas id="garden-canvas" width="1024" height="640" aria-label="Área do Jardim 2D"></canvas>
  <div id="info-panel" aria-live="polite" aria-atomic="true">
    <h2>Informações</h2>
    <div id="coin-count" aria-live="polite" aria-atomic="true">Moedas: 5000</div>
    <div id="inventory" aria-label="Inventário do jogador" tabindex="0">
      <h3>Inventário</h3>
      <div id="inventory-list" role="list"></div>
    </div>
    <p><strong>Controles:</strong> Use as setas ou WASD para mover o personagem. Pressione <kbd>E</kbd> próximo ao vendedor de frutas para abrir a lojinha de vendas. Pressione <kbd>Q</kbd> próximo ao vendedor de sementes para abrir a loja de sementes e comprar. Pressione <kbd>5</kbd> para plantar e <kbd>6</kbd> para colher. O crescimento das plantas é automático (aprox. 1 minuto por planta). Colha a planta quando estiver madura.</p>
  </div>

  <div id="seller-info-fruits" aria-label="Vendedor de frutas">
    <img src="https://pbs.twimg.com/media/EXV9DNhVcAEJz1l.png" alt="Imagem do vendedor de frutas estilizado" class="seller-img" />
    <span>Vendedor de frutas: <kbd>E</kbd> abre a loja</span>
  </div>

  <div id="seller-info-seeds" aria-label="Vendedor de sementes">
    <img src="https://i.pinimg.com/originals/82/7f/ba/827fba5fcec845b8990afcde7d9d0926.png" alt="Imagem do vendedor de sementes estilizado" class="seller-img" />
    <span>Vendedor de sementes: <kbd>Q</kbd> abre a loja</span>
  </div>

  <div id="seller-info-pet" aria-label="Amigo Pet">
    <img src="https://static.wikia.nocookie.net/growagarden/images/f/f3/GoldenLabPet.png/revision/latest/scale-to-width-down/250?cb=20250515232516" alt="Sprite do pet, cachorro dourado estilo desenho animado, colorido e simpático" />
    <span>Pet amigo: reduz 5s de espera das frutas</span>
  </div>
  
  <div id="shop-modal-fruits" role="dialog" aria-modal="true" aria-labelledby="shop-title-fruits" tabindex="-1">
    <h3 id="shop-title-fruits">Lojinha do Vendedor (Frutas)</h3>
    <ul id="shop-list-fruits" tabindex="0" aria-label="Frutas para vender"></ul>
    <button id="shop-close-btn-fruits" aria-label="Fechar lojinha">Fechar</button>
  </div>

  <div id="shop-modal-seeds" role="dialog" aria-modal="true" aria-labelledby="shop-title-seeds" tabindex="-1">
    <h3 id="shop-title-seeds">Lojinha do Vendedor (Sementes)</h3>
    <div id="shop-reset-timer">Loja resetando em: <span id="reset-time">04:00</span></div>
    <ul id="shop-list-seeds" tabindex="0" aria-label="Sementes para comprar"></ul>
    <button id="shop-close-btn-seeds" aria-label="Fechar lojinha">Fechar</button>
  </div>
</div>

<!-- Mobile controls - VERSÃO ATUALIZADA -->
<div id="mobile-controls" aria-label="Controles para dispositivos móveis">
  <div id="mobile-direction-pad">
    <button class="mobile-btn" id="btn-up" aria-label="Mover para cima">↑</button>
    <button class="mobile-btn" id="btn-left" aria-label="Mover para esquerda">←</button>
    <button class="mobile-btn" id="btn-down" aria-label="Mover para baixo">↓</button>
    <button class="mobile-btn" id="btn-right" aria-label="Mover para direita">→</button>
  </div>
  
  <div id="mobile-action-buttons">
    <button class="mobile-btn action-btn" id="btn-plant" aria-label="Plantar semente">Plantar</button>
    <button class="mobile-btn action-btn" id="btn-harvest" aria-label="Colher planta">Colher</button>
    <button class="mobile-btn action-btn" id="btn-shop-fruits" aria-label="Abrir loja de frutas">Loja Frutas</button>
    <button class="mobile-btn action-btn" id="btn-shop-seeds" aria-label="Abrir loja de sementes">Loja Sementes</button>
  </div>
</div>

<!-- Background OST - Música atualizada -->
<audio id="game-ost" loop preload="auto">
  <source src="https://www.youtube.com/watch?v=cl68eYKej7k" type="audio/mpeg">
  Seu navegador não suporta o elemento de áudio.
</audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
  'use strict';

  const canvas = document.getElementById('garden-canvas');
  const ctx = canvas.getContext('2d');
  const coinCountEl = document.getElementById('coin-count');
  const inventoryList = document.getElementById('inventory-list');
  const shopModalFruits = document.getElementById('shop-modal-fruits');
  const shopListFruits = document.getElementById('shop-list-fruits');
  const shopCloseBtnFruits = document.getElementById('shop-close-btn-fruits');
  const shopModalSeeds = document.getElementById('shop-modal-seeds');
  const shopListSeeds = document.getElementById('shop-list-seeds');
  const shopCloseBtnSeeds = document.getElementById('shop-close-btn-seeds');
  const startButton = document.getElementById('start-button');
  const startScreen = document.getElementById('start-screen');
  const loginScreen = document.getElementById('login-screen');
  const loginButton = document.getElementById('login-button');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const genderSelect = document.getElementById('gender');
  const gameContainer = document.getElementById('game-container');
  const mobileControls = document.getElementById('mobile-controls');
  
  const characterImgMale = new Image();
  characterImgMale.src = 'https://i.pinimg.com/originals/d7/18/dc/d718dcbe1181bc4a702e3743c4366ea6.png';
  const characterImgFemale = new Image();
  characterImgFemale.src = 'https://i.pinimg.com/originals/8d/e3/05/8de305bae18de10fbede76282d1cf3c4.png';
  const sellerImgFruits = new Image();
  sellerImgFruits.src = 'https://pbs.twimg.com/media/EXV9DNhVcAEJz1l.png';
  const sellerImgSeeds = new Image();
  sellerImgSeeds.src = 'https://i.pinimg.com/originals/82/7f/ba/827fba5fcec845b8990afcde7d9d0926.png';
  const gameOst = document.getElementById('game-ost');

  // Sprites dos pets
  const petImg = new Image();
  petImg.src = 'https://tiermaker.com/images/media/template_images/2024/16807765/grow-a-garden-pet-16807765/cat.png';
  
  const raccoonImg = new Image();
  raccoonImg.src = 'https://tr.rbxcdn.com/180DAY-24e6da41abd816b879b34aa5d968944f/420/420/Hat/Webp/noFilter';
  
  const beeImg = new Image();
  beeImg.src = 'https://tr.rbxcdn.com/180DAY-1924d553e8d83a2d2f800183fa7f40f6/420/420/Hat/Webp/noFilter';

  // Configurações do mapa aumentado
  const TILE_SIZE = 64;
  const GRID_COLS = 16;
  const GRID_ROWS = 10;
  
  // Posições dos vendedores nos cantos
  const sellerPosFruits = { x: GRID_COLS - 2, y: 1 };
  const sellerPosSeeds = { x: 1, y: GRID_ROWS - 2 };
  
  // Posição inicial do jogador
  const playerInitialPos = { x: 2, y: 2 };

  // Mapa de solo - marrom onde pode plantar
  const soilMap = Array(GRID_ROWS).fill().map((_, row) => 
    Array(GRID_COLS).fill().map((_, col) => {
      // Áreas plantáveis são os quadrantes centrais
      const inTopLeft = row >= 1 && row <= 4 && col >= 1 && col <= 6;
      const inTopRight = row >= 1 && row <= 4 && col >= 9 && col <= 14;
      const inBottomLeft = row >= 5 && row <= 8 && col >= 1 && col <= 6;
      const inBottomRight = row >= 5 && row <= 8 && col >= 9 && col <= 14;
      return inTopLeft || inTopRight || inBottomLeft || inBottomRight ? 1 : 0;
    })
  );

  const rarityTimes = {
    'Comum': 10000,
    'Raro': 30000,
    'Épica': 60000,
    'Lendária': 90000,
    'Mitico': 120000,
    'Especial': 30000
  };

  // Variantes de plantas
  const PLANT_VARIANTS = {
    NORMAL: { chance: 0.85, bonus: 1, color: null, symbol: '' },
    GOLDEN: { chance: 0.03, bonus: 2, color: '#ffd700', symbol: '★' },
    SILVER: { chance: 0.07, bonus: 1.5, color: '#c0c0c0', symbol: '✦' },
    CRYSTAL: { chance: 0.05, bonus: 1.8, color: '#00bcd4', symbol: '❄' },
    POLINIZED: { chance: 0, bonus: 1.4, color: '#f1c40f', symbol: '🐝' } // Nova variante para plantas polinizadas
  };

  // PREÇOS BALANCEADOS (COMPRA/VENDA)
  const SEEDS = [
    // Comum - ROI ~2x
    {name: 'Cenoura', cost: 200, rarity: 'Comum', sellPrice: 400, color: '#ff7f50', icon: '🥕', desc: 'Básica para iniciantes'},
    {name: 'Morango', cost: 350, rarity: 'Comum', sellPrice: 700, color: '#d02e2e', icon: '🍓', desc: 'Rendimento decente'},
    {name: 'Laranja', cost: 500, rarity: 'Comum', sellPrice: 1000, color: '#ffa500', icon: '🍊', desc: 'Clássica cítrica'},
    
    // Raro - ROI ~2.5x
    {name: 'Girassol', cost: 800, rarity: 'Raro', sellPrice: 2000, color: '#f1c40f', icon: '🌻', desc: 'Demora mas vale a pena'},
    {name: 'Abacaxi', cost: 1200, rarity: 'Raro', sellPrice: 3000, color: '#fbe870', icon: '🍍', desc: 'Investimento tropical'},
    {name: 'Maçã', cost: 1500, rarity: 'Raro', sellPrice: 3750, color: '#e74c3c', icon: '🍎', desc: 'Colheita premium'},
    
    // Épica - ROI ~3x
    {name: 'Banana', cost: 2000, rarity: 'Épica', sellPrice: 6000, color: '#ffe135', icon: '🍌', desc: 'Para fazendeiros experientes'},
    {name: 'Uva', cost: 3000, rarity: 'Épica', sellPrice: 9000, color: '#6f2da8', icon: '🍇', desc: 'Vinhedo de alto padrão'},
    {name: 'Manga', cost: 4000, rarity: 'Épica', sellPrice: 12000, color: '#ffb347', icon: '🥭', desc: 'Sabor caro'},
    {name: 'Flor de Lótus', cost: 3500, rarity: 'Épica', sellPrice: 10500, color: '#e6a8d7', icon: '🌸', desc: 'Flor sagrada rara'},
    
    // Lendária - ROI ~3.5x
    {name: 'Melancia', cost: 6000, rarity: 'Lendária', sellPrice: 21000, color: '#4cd137', icon: '🍉', desc: 'Investimento pesado'},
    {name: 'Cereja', cost: 8000, rarity: 'Lendária', sellPrice: 28000, color: '#b11226', icon: '🍒', desc: 'Luxo frutal'},
    {name: 'Maracujá', cost: 10000, rarity: 'Lendária', sellPrice: 35000, color: '#ffcb05', icon: '🍈', desc: 'Para milionários'},
    {name: 'Orquídea Negra', cost: 12000, rarity: 'Lendária', sellPrice: 42000, color: '#663399', icon: '🌺', desc: 'Flor lendária raríssima'},
    
    // Mítico - ROI ~4x
    {name: 'Pitaya', cost: 15000, rarity: 'Mitico', sellPrice: 60000, color: '#ff3399', icon: '🐉', desc: 'Cultivo de elite'},
    {name: 'Durian', cost: 25000, rarity: 'Mitico', sellPrice: 100000, color: '#a2d729', icon: '🌰', desc: 'Só para magnatas'},
    {name: 'Kiwi dourado', cost: 30000, rarity: 'Mitico', sellPrice: 120000, color: '#ffd700', icon: '🥝', desc: 'Investimento bilionário'},
    
    // Especial - Evento
    {name: 'Árvore de Algodão', cost: 65000, rarity: 'Especial', sellPrice: 130000, color: '#ffffff', icon: '🌳', desc: 'Evento especial - disponível por tempo limitado!'}
  ];

  // Configurações dos pets
  const PETS = {
    CAT: {
      name: 'Amigo Pet',
      cost: 50000,
      icon: '🐾',
      desc: 'Reduz 5 segundos do tempo de espera das frutas',
      img: petImg,
      effect: (plant) => {
        if(plant) plant.growTimeMs = Math.max(1000, plant.growTimeMs - 5000);
      }
    },
    RACCOON: {
      name: 'Guaxinim Coletor',
      cost: 150000,
      icon: '🦝',
      desc: 'A cada 2 minutos coleta uma semente épica, lendária ou mítica',
      img: raccoonImg,
      effect: (gameState) => {
        // 75% épica, 24% lendária, 1% mítica
        const rand = Math.random();
        let seedType;
        
        if(rand <= 0.75) {
          // Épica (índices 6-9)
          seedType = Math.floor(Math.random() * 4) + 6;
        } else if(rand <= 0.99) {
          // Lendária (índices 10-13)
          seedType = Math.floor(Math.random() * 4) + 10;
        } else {
          // Mítica (índices 14-16)
          seedType = Math.floor(Math.random() * 3) + 14;
        }
        
        if(!gameState.inventory[seedType]) gameState.inventory[seedType] = 0;
        gameState.inventory[seedType]++;
        updateUI();
        return SEEDS[seedType].name;
      }
    },
    BEE: {
      name: 'Abelha Polinizadora',
      cost: 100000,
      icon: '🐝',
      desc: 'A cada 1 minuto poliniza uma planta aleatória, aumentando 1.4x seu valor',
      img: beeImg,
      effect: (gameState) => {
        // Encontra todas as plantas no jardim
        const plants = [];
        for(let y = 0; y < GRID_ROWS; y++) {
          for(let x = 0; x < GRID_COLS; x++) {
            if(gameState.garden[y][x]) {
              plants.push({x, y, plant: gameState.garden[y][x]});
            }
          }
        }
        
        if(plants.length > 0) {
          // Escolhe uma planta aleatória
          const randomPlant = plants[Math.floor(Math.random() * plants.length)];
          randomPlant.plant.variant = 'POLINIZED';
          draw();
          return SEEDS[randomPlant.plant.seedIdx].name;
        }
        return null;
      }
    }
  };

  // Sistema de estoque da loja
  let shopStock = {};
  let shopResetTimer = null;
  let shopResetTime = 4 * 60; // 4 minutos em segundos
  
  // Timer para evento especial (Árvore de Algodão)
  let eventEndTime = Date.now() + (14 * 24 * 60 * 60 * 1000); // 2 semanas a partir de agora
  
  function generateShopStock() {
    shopStock = {};
    
    // Primeiro geramos as sementes normais (todas exceto Árvore de Algodão)
    SEEDS.forEach((seed, idx) => {
      // Pula a Árvore de Algodão - ela será tratada separadamente
      if(seed.name === 'Árvore de Algodão') return;
      
      let chance;
      switch(seed.rarity) {
        case 'Comum': chance = 0.75; break;
        case 'Raro': chance = 0.5; break;
        case 'Épica': chance = 0.3; break;
        case 'Lendária': chance = 0.05; break;
        case 'Mitico': chance = 0.01; break;
        default: chance = 0.5;
      }
      
      if(Math.random() < chance) {
        const quantity = Math.floor(Math.random() * 20) + 1; // 1-20
        shopStock[idx] = quantity;
      }
    });
    
    // Tratamento especial para Árvore de Algodão - 0.2% de chance
    const cottonIndex = SEEDS.findIndex(s => s.name === 'Árvore de Algodão');
    if(Math.random() < 0.002 && Date.now() < eventEndTime) { // 0.2% de chance
      shopStock[cottonIndex] = 1; // Apenas 1 disponível
    }
    
    // Resetar o timer
    shopResetTime = 4 * 60;
    updateShopTimer();
    
    // Resetar o timer se já existir
    if(shopResetTimer) clearInterval(shopResetTimer);
    shopResetTimer = setInterval(updateShopTimer, 1000);
  }

  function updateShopTimer() {
    shopResetTime--;
    if(shopResetTime <= 0) {
      generateShopStock();
      if(shopModalSeeds.style.display === 'flex') {
        buildShopListSeeds();
      }
    } else {
      const minutes = Math.floor(shopResetTime / 60);
      const seconds = shopResetTime % 60;
      const timerElement = document.getElementById('reset-time');
      if(timerElement) {
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }
  }

  // Dinheiro inicial ajustado para 5000
  let gameState = {
    coins: 5000,
    garden: Array(GRID_ROWS).fill(null).map(() => Array(GRID_COLS).fill(null)),
    playerPos: {x:0, y:0},
    inventory: {},
    shopOpenFruits: false,
    shopOpenSeeds: false,
    ownedPets: {}, // Agora pode ter múltiplos pets
    playerSkinImg: null,
    username: '',
    playerId: Math.random().toString(36).substr(2, 9)
  };
  
  let petPositions = {
    cat: { x: Math.max(0, gameState.playerPos.x -1), y: gameState.playerPos.y },
    raccoon: { x: Math.max(0, gameState.playerPos.x -2), y: gameState.playerPos.y },
    bee: { x: Math.max(0, gameState.playerPos.x -3), y: gameState.playerPos.y }
  };

  function getRandomVariant() {
    const rand = Math.random();
    let cumulative = 0;
    for(const [key, variant] of Object.entries(PLANT_VARIANTS)) {
      cumulative += variant.chance;
      if(rand <= cumulative) {
        return key;
      }
    }
    return 'NORMAL';
  }

  function drawGrid(){
    for(let r=0; r<GRID_ROWS; r++){
      for(let c=0; c<GRID_COLS; c++){
        // Desenha o chão - marrom onde pode plantar, verde onde não pode
        if(soilMap[r][c] === 1) {
          ctx.fillStyle = ((r+c)%2===0)? '#a67c52' : '#8c5e36'; // Tons de marrom
        } else {
          ctx.fillStyle = ((r+c)%2===0)? '#8abf56' : '#7bb144'; // Tons de verde
        }
        ctx.fillRect(c*TILE_SIZE, r*TILE_SIZE, TILE_SIZE, TILE_SIZE);

        // Desenha plantas do jogador principal
        const plant = gameState.garden[r][c];
        if(plant){
          drawPlant(r, c, plant);
        }
      }
    }
    drawSeller(sellerPosFruits, sellerImgFruits);
    drawSeller(sellerPosSeeds, sellerImgSeeds);
  }

  function drawPlant(r, c, plant) {
    const seed = SEEDS[plant.seedIdx];
    const elapsed = Date.now() - plant.plantedAt;
    let growTimeMs = rarityTimes[seed.rarity] || 60000;
    
    // Aplica efeito do pet gato se existir
    if(gameState.ownedPets.cat) {
      growTimeMs = Math.max(1000, growTimeMs - 5000);
    }
    
    const progress = Math.min(elapsed/growTimeMs,1);
    const radius = progress * (TILE_SIZE / 2 - 8);
    
    // Cor baseada na variante
    let plantColor = seed.color;
    if(plant.variant === 'GOLDEN') plantColor = '#ffd700';
    else if(plant.variant === 'SILVER') plantColor = '#c0c0c0';
    else if(plant.variant === 'CRYSTAL') plantColor = '#00bcd4';
    else if(plant.variant === 'POLINIZED') plantColor = '#f1c40f';
    
    ctx.beginPath();
    if(plant.variant !== 'NORMAL') {
      const gradient = ctx.createRadialGradient(
        c*TILE_SIZE + TILE_SIZE/2,
        r*TILE_SIZE + TILE_SIZE/2,
        8,
        c*TILE_SIZE + TILE_SIZE/2,
        r*TILE_SIZE + TILE_SIZE/2,
        radius > 8 ? radius : 8
      );
      gradient.addColorStop(0, '#fffacd');
      gradient.addColorStop(1, plantColor);
      ctx.fillStyle = gradient;
    } else {
      ctx.fillStyle = plantColor;
    }
    
    ctx.globalAlpha = 0.5;
    ctx.arc(c*TILE_SIZE + TILE_SIZE/2, r*TILE_SIZE + TILE_SIZE/2 + 8, radius > 8 ? radius : 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.font = '36px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(seed.icon, c*TILE_SIZE + TILE_SIZE/2, r*TILE_SIZE + TILE_SIZE/2);
    
    // Desenha indicador de variante se não for normal
    if(plant.variant !== 'NORMAL') {
      const variant = PLANT_VARIANTS[plant.variant];
      ctx.fillStyle = variant.color;
      ctx.font = '20px Arial';
      ctx.fillText(variant.symbol, c*TILE_SIZE + TILE_SIZE/2 + 20, r*TILE_SIZE + TILE_SIZE/2 - 20);
    }
    
    if(progress >= 1){
      ctx.strokeStyle = plant.variant !== 'NORMAL' ? PLANT_VARIANTS[plant.variant].color : '#2ecc40';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(c*TILE_SIZE + TILE_SIZE/2, r*TILE_SIZE + TILE_SIZE/2 + 8, TILE_SIZE/2 - 6, 0, Math.PI * 2);
      ctx.stroke();
      plant.isMature = true;
    } else {
      plant.isMature = false;
    }
  }

  function drawSeller(pos, img){
    const px = pos.x * TILE_SIZE;
    const py = pos.y * TILE_SIZE;
    const scale = 0.25;
    const imgW = img.width * scale;
    const imgH = img.height * scale;
    const drawX = px + TILE_SIZE/2 - imgW/2;
    const drawY = py + TILE_SIZE - imgH * 0.9;
    if(img.complete){
      ctx.drawImage(img, drawX, drawY, imgW, imgH);
    } else {
      img.onload = () => draw();
    }
  }

  function drawPlayer(){
    const px = gameState.playerPos.x * TILE_SIZE;
    const py = gameState.playerPos.y * TILE_SIZE;
    const scale = 0.2;
    const imgW = gameState.playerSkinImg.width * scale;
    const imgH = gameState.playerSkinImg.height * scale;
    const drawX = px + TILE_SIZE/2 - imgW/2;
    const drawY = py + TILE_SIZE - imgH * 0.9;
    ctx.drawImage(gameState.playerSkinImg, drawX, drawY, imgW, imgH);
    
    // Desenha nome do jogador
    ctx.font = 'bold 12px Arial';
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.textAlign = 'center';
    ctx.fillText(gameState.username, px + TILE_SIZE/2, py - 5);
  }

  function drawPets(){
    // Desenha cada pet que o jogador possui
    for(const petType in gameState.ownedPets) {
      if(gameState.ownedPets[petType]) {
        const pet = PETS[petType];
        const pos = petPositions[petType];
        const px = pos.x * TILE_SIZE;
        const py = pos.y * TILE_SIZE;
        const scale = 0.2;
        const imgW = pet.img.width * scale;
        const imgH = pet.img.height * scale;
        const drawX = px + TILE_SIZE/2 - imgW/2;
        const drawY = py + TILE_SIZE - imgH * 0.9;
        if(pet.img.complete){
          ctx.drawImage(pet.img, drawX, drawY, imgW, imgH);
        }
      }
    }
  }
  
  function movePetsRandomly(){
    for(const petType in gameState.ownedPets) {
      if(gameState.ownedPets[petType]) {
        const directions = [
          { dx: 0, dy: -1 },
          { dx: 0, dy: 1 },
          { dx: -1, dy: 0 },
          { dx: 1, dy: 0 }
        ];
        const randomDirection = directions[Math.floor(Math.random() * directions.length)];
        const newX = petPositions[petType].x + randomDirection.dx;
        const newY = petPositions[petType].y + randomDirection.dy;
        if(newX >= 0 && newX < GRID_COLS && newY >=0 && newY < GRID_ROWS){
          if(!((newX === gameState.playerPos.x && newY === gameState.playerPos.y) ||
               (newX === sellerPosFruits.x && newY === sellerPosFruits.y) ||
               (newX === sellerPosSeeds.x && newY === sellerPosSeeds.y))) {
            petPositions[petType].x = newX;
            petPositions[petType].y = newY;
          }
        }
      }
    }
  }

  function draw(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawGrid();
    drawPlayer();
    drawPets();
  }

  function updateUI(){
    coinCountEl.textContent = 'Moedas: ' + gameState.coins;
    updateInventoryUI();
  }

  function updateInventoryUI(){
    inventoryList.innerHTML = '';
    const seedKeys = Object.keys(gameState.inventory).filter(k => k !== 'fruits');
    const fruitKeys = (gameState.inventory.fruits) ? Object.keys(gameState.inventory.fruits) : [];

    if(seedKeys.length === 0 && fruitKeys.length === 0 && Object.keys(gameState.ownedPets).length === 0){
      const empty = document.createElement('div');
      empty.textContent = 'Inventário vazio';
      empty.style.color = '#555';
      inventoryList.appendChild(empty);
      return;
    }

    if(seedKeys.length > 0){
      const seedsHeader = document.createElement('div');
      seedsHeader.textContent = 'Sementes:';
      seedsHeader.style.fontWeight = '700';
      inventoryList.appendChild(seedsHeader);

      for(const idx of seedKeys){
        const count = gameState.inventory[idx];
        if(count > 0){
          const seedIdx = Number(idx);
          const item = document.createElement('div');
          item.className = 'inventory-item';
          const seed = SEEDS[seedIdx];
          item.textContent = `${seed.icon} Semente de ${seed.name} x${count}`;
          inventoryList.appendChild(item);
        }
      }
    }

    if(fruitKeys.length > 0){
      const fruitsHeader = document.createElement('div');
      fruitsHeader.textContent = 'Frutas para vender:';
      fruitsHeader.style.fontWeight = '700';
      fruitsHeader.style.marginTop = '12px';
      inventoryList.appendChild(fruitsHeader);

      for(const idx of fruitKeys){
        const count = gameState.inventory.fruits[idx];
        if(count > 0){
          const seedIdx = Number(idx);
          const item = document.createElement('div');
          item.className = 'inventory-item';
          const seed = SEEDS[seedIdx];
          item.textContent = `${seed.icon} ${seed.name} maduro x${count}`;
          inventoryList.appendChild(item);
        }
      }
    }

    // Mostra os pets no inventário
    if(Object.keys(gameState.ownedPets).length > 0){
      const petsHeader = document.createElement('div');
      petsHeader.textContent = 'Pets:';
      petsHeader.style.fontWeight = '700';
      petsHeader.style.marginTop = '12px';
      inventoryList.appendChild(petsHeader);

      for(const petType in gameState.ownedPets) {
        if(gameState.ownedPets[petType]) {
          const pet = PETS[petType];
          const petItem = document.createElement('div');
          petItem.className = 'inventory-item';
          petItem.textContent = `${pet.icon} ${pet.name} (${pet.desc})`;
          inventoryList.appendChild(petItem);
        }
      }
    }
  }

  function movePlayer(dx, dy){
    const nx = gameState.playerPos.x + dx;
    const ny = gameState.playerPos.y + dy;
    if(nx >= 0 && nx < GRID_COLS && ny >= 0 && ny < GRID_ROWS){
      gameState.playerPos.x = nx;
      gameState.playerPos.y = ny;
      
      // Move os pets para perto do jogador
      petPositions.cat = { 
        x: Math.max(0, gameState.playerPos.x -1), 
        y: gameState.playerPos.y 
      };
      petPositions.raccoon = { 
        x: Math.max(0, gameState.playerPos.x -2), 
        y: gameState.playerPos.y 
      };
      petPositions.bee = { 
        x: Math.max(0, gameState.playerPos.x -3), 
        y: gameState.playerPos.y 
      };
      
      draw();
    }
  }

  function plantSeedFromInventory(){
    const {x, y} = gameState.playerPos;
    
    // Verifica se está em área de solo marrom (onde pode plantar)
    if(soilMap[y][x] !== 1) {
      alert('Você só pode plantar na área marrom (terra fértil)!');
      return;
    }
    
    if(gameState.garden[y][x]){
      alert('Já existe uma planta aqui!');
      return;
    }
    const seedsInInventory = Object.entries(gameState.inventory).filter(([k,v]) => v > 0 && k !== 'fruits');
    if(seedsInInventory.length === 0){
      alert('Você não tem sementes no inventário. Compre com o vendedor de sementes (Q).');
      return;
    }
    const [seedIdxStr, count] = seedsInInventory[0];
    const seedIdx = Number(seedIdxStr);
    gameState.inventory[seedIdx]--;
    if(gameState.inventory[seedIdx] <= 0) delete gameState.inventory[seedIdx];
    
    const variant = getRandomVariant();
    gameState.garden[y][x] = {
      seedIdx,
      plantedAt: Date.now(),
      isMature: false,
      variant
    };
    
    let variantMsg = '';
    if(variant !== 'NORMAL') {
      const variantInfo = PLANT_VARIANTS[variant];
      variantMsg = ` (Variante ${variant.toLowerCase()} - ${variantInfo.symbol})`;
    }
    
    alert(`Você plantou a semente de ${SEEDS[seedIdx].name}${variantMsg}.`);
    updateUI();
    draw();
  }

  function harvestPlants(){
    const pos = gameState.playerPos;
    const plant = gameState.garden[pos.y][pos.x];
    if(!plant){
      alert('Não há planta para colher aqui!');
      return;
    }
    const seed = SEEDS[plant.seedIdx];
    let growTimeMs = rarityTimes[seed.rarity] || 60000;
    
    // Aplica efeito do pet gato se existir
    if(gameState.ownedPets.cat) {
      growTimeMs = Math.max(1000, growTimeMs - 5000);
    }
    
    const elapsed = Date.now() - plant.plantedAt;

    if(elapsed < growTimeMs || !plant.isMature){
      alert('Planta ainda não está madura!');
      return;
    }
    if(!gameState.inventory.fruits) gameState.inventory.fruits = {};
    if(!gameState.inventory.fruits[plant.seedIdx]) gameState.inventory.fruits[plant.seedIdx] = 0;
    
    // Calcula o preço com bônus da variante
    const variantBonus = PLANT_VARIANTS[plant.variant].bonus;
    const sellPrice = Math.round(seed.sellPrice * variantBonus);
    
    gameState.inventory.fruits[plant.seedIdx]++;
    gameState.garden[pos.y][pos.x] = null;
    
    let variantMsg = '';
    if(plant.variant !== 'NORMAL') {
      variantMsg = ` (Variante ${plant.variant.toLowerCase()} - valor ${variantBonus}x)`;
    }
    
    alert(`Você colheu 1x ${seed.name}${variantMsg} para vender por ${sellPrice} moedas!`);
    updateUI();
    draw();
  }

  function buildShopListFruits(){
    shopListFruits.innerHTML = '';
    
    if(!gameState.inventory.fruits || Object.keys(gameState.inventory.fruits).length === 0) {
      const emptyMsg = document.createElement('div');
      emptyMsg.className = 'fruit-item';
      emptyMsg.innerHTML = `
        <div style="text-align: center; width: 100%;">
          Nenhuma fruta madura no inventário
        </div>
      `;
      shopListFruits.appendChild(emptyMsg);
      return;
    }

    // Criar array com todas as frutas disponíveis no inventário
    const fruitsForSale = Object.entries(gameState.inventory.fruits)
      .map(([seedIdx, count]) => {
        const seed = SEEDS[Number(seedIdx)];
        return {
          seedIdx: Number(seedIdx),
          count,
          totalPrice: seed.sellPrice * count,
          seed
        };
      })
      .sort((a, b) => a.totalPrice - b.totalPrice); // Ordenar do mais barato ao mais caro

    // Adicionar cada fruta à lista
    fruitsForSale.forEach(({seedIdx, count, totalPrice, seed}) => {
      const fruitEl = document.createElement('div');
      fruitEl.className = 'fruit-item';
      fruitEl.innerHTML = `
        <div style="display: flex; align-items: center;">
          <span class="fruit-icon">${seed.icon}</span>
          <div class="fruit-details">
            <div class="fruit-name">${seed.name} ×${count}</div>
            <div class="fruit-rarity rarity-${seed.rarity.toLowerCase()}">${seed.rarity}</div>
          </div>
        </div>
        <div class="fruit-price">${totalPrice} <small>moedas</small></div>
      `;
      
      fruitEl.addEventListener('click', () => sellFruit(seedIdx, count));
      shopListFruits.appendChild(fruitEl);
    });

    // Adicionar opção para vender pets
    for(const petType in gameState.ownedPets) {
      if(gameState.ownedPets[petType]) {
        const pet = PETS[petType];
        const sellPrice = Math.floor(pet.cost * 0.5); // Vende por 50% do valor
        
        const petEl = document.createElement('div');
        petEl.className = 'fruit-item';
        petEl.style.background = 'linear-gradient(135deg, #f59e0b 0%, #f97316 100%)';
        petEl.innerHTML = `
          <div style="display: flex; align-items: center;">
            <span class="fruit-icon">${pet.icon}</span>
            <div class="fruit-details">
              <div class="fruit-name">${pet.name}</div>
              <div class="fruit-rarity">Especial</div>
            </div>
          </div>
          <div class="fruit-price">${sellPrice} <small>moedas</small></div>
        `;
        
        petEl.addEventListener('click', () => {
          if(confirm(`Vender seu ${pet.name} por ${sellPrice} moedas?`)) {
            gameState.coins += sellPrice;
            delete gameState.ownedPets[petType];
            updateUI();
            closeShopFruits();
            draw();
          }
        });
        
        shopListFruits.appendChild(petEl);
      }
    }
  }

  function sellFruit(seedIdx, count){
    if(!gameState.inventory.fruits || gameState.inventory.fruits[seedIdx] < count) return;
    gameState.inventory.fruits[seedIdx] -= count;
    if(gameState.inventory.fruits[seedIdx] <= 0){
      delete gameState.inventory.fruits[seedIdx];
    }
    const gained = SEEDS[seedIdx].sellPrice * count;
    gameState.coins += gained;
    alert(`Você vendeu ${count} ${SEEDS[seedIdx].name}(s) por ${gained} moedas!`);
    updateUI();
    closeShopFruits();
    draw();
  }

  function openShopFruits(){
    if(!isNear(gameState.playerPos,sellerPosFruits)){
      alert('Aproxime-se do vendedor de frutas para abrir a loja.');
      return;
    }
    buildShopListFruits();
    shopModalFruits.style.display = 'flex';
    gameState.shopOpenFruits = true;
    shopModalFruits.setAttribute('aria-hidden', 'false');
    shopModalFruits.focus();
  }

  function closeShopFruits(){
    shopModalFruits.style.display = 'none';
    gameState.shopOpenFruits = false;
    shopModalFruits.setAttribute('aria-hidden', 'true');
  }

  function buildShopListSeeds(){
    shopListSeeds.innerHTML = '';
    
    // Adicionar contador de tempo para evento especial
    if(Date.now() < eventEndTime) {
      const eventTimer = document.createElement('div');
      eventTimer.style.background = 'rgba(255, 215, 0, 0.2)';
      eventTimer.style.padding = '8px';
      eventTimer.style.borderRadius = '12px';
      eventTimer.style.marginBottom = '16px';
      eventTimer.style.textAlign = 'center';
      eventTimer.style.fontWeight = '600';
      eventTimer.style.color = '#b8860b';
      
      const timeLeft = eventEndTime - Date.now();
      const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
      const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      
      eventTimer.innerHTML = `
        <div>🌳 Evento Especial: Árvore de Algodão 🌳</div>
        <div style="font-size: 0.9rem;">Disponível por mais: ${daysLeft}d ${Math.floor(hoursLeft)}h</div>
        <div style="font-size: 0.8rem; margin-top: 4px;">Chance de aparecer: 0.2%</div>
      `;
      shopListSeeds.appendChild(eventTimer);
    }
    
    // Criar array com todas as sementes disponíveis no estoque
    const availableSeeds = [];
    SEEDS.forEach((seed, idx) => {
      // Só mostra a Árvore de Algodão se estiver no estoque e o evento estiver ativo
      if(seed.name === 'Árvore de Algodão') {
        if(shopStock[idx] > 0 && Date.now() < eventEndTime) {
          availableSeeds.push({...seed, stock: shopStock[idx], idx});
        }
        return;
      }
      
      if(shopStock[idx] > 0) {
        availableSeeds.push({...seed, stock: shopStock[idx], idx});
      }
    });
    
    // Ordenar do mais barato ao mais caro
    availableSeeds.sort((a, b) => a.cost - b.cost);
    
    // Agrupar por raridade mantendo a ordem de preço
    const seedsByRarity = {
      'Comum': [],
      'Raro': [],
      'Épica': [],
      'Lendária': [],
      'Mitico': [],
      'Especial': []
    };
    
    availableSeeds.forEach(seed => {
      seedsByRarity[seed.rarity].push(seed);
    });
    
    // Adicionar cada grupo de raridade
    Object.entries(seedsByRarity).forEach(([rarity, seeds]) => {
      if(seeds.length === 0) return;
      
      // Adicionar cabeçalho da raridade
      const rarityHeader = document.createElement('h4');
      rarityHeader.textContent = `${rarity} (${seeds.length})`;
      rarityHeader.style.margin = '16px 0 8px 0';
      rarityHeader.style.color = getRarityColor(rarity);
      shopListSeeds.appendChild(rarityHeader);
      
      // Adicionar cada semente do grupo (já está ordenado por preço)
      seeds.forEach(seed => {
        const seedEl = document.createElement('div');
        seedEl.className = 'seed-item';
        
        const seedHeader = document.createElement('div');
        seedHeader.className = 'seed-header';
        seedHeader.innerHTML = `
          <span class="seed-icon">${seed.icon}</span>
          <span class="seed-name">${seed.name}</span>
          <span class="seed-rarity rarity-${rarity.toLowerCase()}-bg">${rarity}</span>
        `;
        
        const seedDesc = document.createElement('div');
        seedDesc.className = 'seed-desc';
        seedDesc.textContent = seed.desc;
        
        const stockInfo = document.createElement('div');
        stockInfo.style.fontSize = '0.85rem';
        stockInfo.style.color = '#475569';
        stockInfo.textContent = `Estoque: ${seed.stock}`;
        seedDesc.appendChild(document.createElement('br'));
        seedDesc.appendChild(stockInfo);
        
        const buyBtn = document.createElement('button');
        buyBtn.className = 'seed-buy-btn';
        buyBtn.disabled = gameState.coins < seed.cost || seed.stock <= 0;
        buyBtn.innerHTML = `
          <span>Comprar</span>
          <span>${seed.cost} moedas</span>
        `;
        buyBtn.onclick = () => buySeed(seed.idx);
        
        seedEl.appendChild(seedHeader);
        seedEl.appendChild(seedDesc);
        seedEl.appendChild(buyBtn);
        
        shopListSeeds.appendChild(seedEl);
      });
    });
    
    // Adicionar seção de pets (ordenados do mais barato ao mais caro)
    const petsHeader = document.createElement('h4');
    petsHeader.textContent = 'Pets (3)';
    petsHeader.style.margin = '16px 0 8px 0';
    petsHeader.style.color = '#f59e0b';
    shopListSeeds.appendChild(petsHeader);
    
    // Criar array de pets e ordenar por preço
    const availablePets = Object.entries(PETS).map(([petType, pet]) => ({
      petType,
      ...pet
    })).sort((a, b) => a.cost - b.cost);
    
    // Adicionar cada pet (já ordenado)
    availablePets.forEach(({petType, name, icon, desc, cost}) => {
      const petEl = document.createElement('div');
      petEl.className = 'seed-item';
      
      const petHeaderDiv = document.createElement('div');
      petHeaderDiv.className = 'seed-header';
      petHeaderDiv.innerHTML = `
        <span class="seed-icon">${icon}</span>
        <span class="seed-name">${name}</span>
        <span class="seed-rarity rarity-legendary-bg">Pet</span>
      `;
      
      const petDesc = document.createElement('div');
      petDesc.className = 'seed-desc';
      petDesc.textContent = desc;
      
      const petBuyBtn = document.createElement('button');
      petBuyBtn.className = 'seed-buy-btn';
      petBuyBtn.disabled = gameState.coins < cost || gameState.ownedPets[petType];
      petBuyBtn.innerHTML = `
        <span>Comprar</span>
        <span>${cost} moedas</span>
      `;
      petBuyBtn.onclick = () => buyPet(petType);
      
      petEl.appendChild(petHeaderDiv);
      petEl.appendChild(petDesc);
      petEl.appendChild(petBuyBtn);
      
      shopListSeeds.appendChild(petEl);
    });
  }

  function getRarityColor(rarity) {
    switch(rarity) {
      case 'Comum': return '#166534';
      case 'Raro': return '#1e40af';
      case 'Épica': return '#5b21b6';
      case 'Lendária': return '#92400e';
      case 'Mitico': return '#991b1b';
      case 'Especial': return '#b8860b';
      default: return '#475569';
    }
  }

  function openShopSeeds(){
    if(!isNear(gameState.playerPos,sellerPosSeeds)){
      alert('Aproxime-se do vendedor de sementes para abrir a loja.');
      return;
    }
    buildShopListSeeds();
    shopModalSeeds.style.display = 'flex';
    gameState.shopOpenSeeds = true;
    shopModalSeeds.setAttribute('aria-hidden', 'false');
    shopModalSeeds.focus();
  }

  function closeShopSeeds(){
    shopModalSeeds.style.display = 'none';
    gameState.shopOpenSeeds = false;
    shopModalSeeds.setAttribute('aria-hidden', 'true');
  }

  function buySeed(seedIdx){
    const seed = SEEDS[seedIdx];
    
    // Verifica se tem moedas suficientes
    if(gameState.coins < seed.cost) {
      alert('Moedas insuficientes para comprar essa semente!');
      return false;
    }
    
    // Verifica se tem estoque
    if(typeof shopStock[seedIdx] === 'undefined' || shopStock[seedIdx] <= 0) {
      alert('Esta semente está esgotada no momento!');
      return false;
    }
    
    // Atualiza o inventário
    if(!gameState.inventory[seedIdx]) {
      gameState.inventory[seedIdx] = 0;
    }
    gameState.inventory[seedIdx]++;
    
    // Debita o valor e atualiza o estoque
    gameState.coins -= seed.cost;
    shopStock[seedIdx]--;
    
    // Atualiza a UI
    updateUI();
    
    // Se a loja estiver aberta, atualiza a lista
    if(shopModalSeeds.style.display === 'flex') {
      buildShopListSeeds();
    }
    
    alert(`Você comprou 1 semente de ${seed.name} por ${seed.cost} moedas!`);
    return true;
  }

  function buyPet(petType){
    const pet = PETS[petType];
    
    if(gameState.coins < pet.cost){
      alert('Moedas insuficientes para comprar este Pet.');
      return;
    }
    
    if(gameState.ownedPets[petType]){
      alert(`Você já possui o ${pet.name}.`);
      return;
    }
    
    gameState.coins -= pet.cost;
    gameState.ownedPets[petType] = true;
    
    // Inicia o efeito do pet
    if(petType === 'raccoon') {
      // Guaxinim coleta sementes a cada 2 minutos
      setInterval(() => {
        if(gameState.ownedPets.raccoon) {
          const seedName = pet.effect(gameState);
          if(seedName) {
            alert(`Seu Guaxinim Coletor encontrou uma semente de ${seedName}!`);
          }
        }
      }, 2 * 60 * 1000); // 2 minutos
    } else if(petType === 'bee') {
      // Abelha poliniza plantas a cada 1 minuto
      setInterval(() => {
        if(gameState.ownedPets.bee) {
          const plantName = pet.effect(gameState);
          if(plantName) {
            alert(`Sua Abelha Polinizadora aumentou o valor de uma ${plantName} em 1.4x!`);
          }
        }
      }, 60 * 1000); // 1 minuto
    }
    
    alert(`Você comprou o ${pet.name}! ${pet.desc}`);
    updateUI();
    closeShopSeeds();
    draw();
  }

  // Save / Load system
  function saveGame() {
    try {
      const gameData = {
        coins: gameState.coins,
        garden: gameState.garden,
        inventory: gameState.inventory,
        ownedPets: gameState.ownedPets,
        playerSkin: gameState.playerSkinImg ? gameState.playerSkinImg.src : null,
        playerPos: gameState.playerPos,
        username: gameState.username,
        eventEndTime: eventEndTime
      };
      localStorage.setItem('growAGardenSave', JSON.stringify(gameData));
      alert('Jogo salvo com sucesso!');
    } catch (e) {
      console.error('Erro ao salvar jogo:', e);
      alert('Erro ao salvar jogo.');
    }
  }

  function loadGame() {
    try {
      const saved = localStorage.getItem('growAGardenSave');
      if(!saved) return false;
      const data = JSON.parse(saved);
      if(!data) return false;

      gameState.coins = data.coins ?? 5000;
      gameState.garden = data.garden ?? Array(GRID_ROWS).fill(null).map(() => Array(GRID_COLS).fill(null));
      gameState.inventory = data.inventory ?? {};
      if(!gameState.inventory.fruits) gameState.inventory.fruits = {};
      gameState.ownedPets = data.ownedPets || {};
      gameState.playerPos = data.playerPos ?? {x:0, y:Math.floor(GRID_ROWS/2)};
      gameState.username = data.username || 'Jogador';
      eventEndTime = data.eventEndTime || (Date.now() + (14 * 24 * 60 * 60 * 1000));

      // Posiciona os pets perto do jogador
      petPositions = {
        cat: { x: Math.max(0, gameState.playerPos.x -1), y: gameState.playerPos.y },
        raccoon: { x: Math.max(0, gameState.playerPos.x -2), y: gameState.playerPos.y },
        bee: { x: Math.max(0, gameState.playerPos.x -3), y: gameState.playerPos.y }
      };

      if(data.playerSkin === characterImgMale.src) gameState.playerSkinImg = characterImgMale;
      else if(data.playerSkin === characterImgFemale.src) gameState.playerSkinImg = characterImgFemale;
      else gameState.playerSkinImg = characterImgMale;

      // Reinicia os efeitos dos pets
      for(const petType in gameState.ownedPets) {
        if(gameState.ownedPets[petType]) {
          const pet = PETS[petType];
          if(petType === 'raccoon') {
            setInterval(() => {
              if(gameState.ownedPets.raccoon) {
                const seedName = pet.effect(gameState);
                if(seedName) {
                  alert(`Seu Guaxinim Coletor encontrou uma semente de ${seedName}!`);
                }
              }
            }, 2 * 60 * 1000);
          } else if(petType === 'bee') {
            setInterval(() => {
              if(gameState.ownedPets.bee) {
                const plantName = pet.effect(gameState);
                if(plantName) {
                  alert(`Sua Abelha Polinizadora aumentou o valor de uma ${plantName} em 1.4x!`);
                }
              }
            }, 60 * 1000);
          }
        }
      }

      alert('Jogo carregado com sucesso!');
      updateUI();
      draw();
      return true;
    } catch (e) {
      console.error('Erro ao carregar jogo:', e);
      alert('Erro ao carregar jogo.');
      return false;
    }
  }

  function addSaveLoadButtons(){
    const infoPanel = document.getElementById('info-panel');

    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.gap = '12px';
    container.style.justifyContent = 'center';
    container.style.marginTop = '10px';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Salvar Jogo';
    saveBtn.className = 'btn';
    saveBtn.style.flex = '1';
    saveBtn.onclick = saveGame;

    const loadBtn = document.createElement('button');
    loadBtn.textContent = 'Carregar Jogo';
    loadBtn.className = 'btn';
    loadBtn.style.flex = '1';
    loadBtn.onclick = () => {
      if(loadGame()){
        draw();
      }
    };

    container.appendChild(saveBtn);
    container.appendChild(loadBtn);
    infoPanel.appendChild(container);
  }

  shopCloseBtnFruits.addEventListener('click', closeShopFruits);
  shopCloseBtnSeeds.addEventListener('click', closeShopSeeds);

  window.addEventListener('keydown', e => {
    if(gameState.shopOpenFruits){
      if(e.key === 'Escape'){
        closeShopFruits();
        e.preventDefault();
      }
      return;
    }
    if(gameState.shopOpenSeeds){
      if(e.key === 'Escape'){
        closeShopSeeds();
        e.preventDefault();
      }
      return;
    }
    switch(e.key){
      case 'ArrowUp':
      case 'w':
      case 'W':
        movePlayer(0, -1);
        e.preventDefault();
        break;
      case 'ArrowDown':
      case 's':
      case 'S':
        movePlayer(0, 1);
        e.preventDefault();
        break;
      case 'ArrowLeft':
      case 'a':
      case 'A':
        movePlayer(-1, 0);
        e.preventDefault();
        break;
      case 'ArrowRight':
      case 'd':
      case 'D':
        movePlayer(1, 0);
        e.preventDefault();
        break;
      case 'e':
      case 'E':
        openShopFruits();
        e.preventDefault();
        break;
      case 'q':
      case 'Q':
        openShopSeeds();
        e.preventDefault();
        break;
      case '5':
        case 'p':
        case 'P':
        plantSeedFromInventory();
        e.preventDefault();
        break;
      case '6':
      case 'h':
      case 'H':
        harvestPlants();
        e.preventDefault();
        break;
    }
  });

  // Start button opens login screen
  startButton.addEventListener('click', () => {
    startScreen.style.display = 'none';
    loginScreen.style.display = 'flex';
  });

  // Login button enters game
  loginButton.addEventListener('click', () => {
    const name = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const gender = genderSelect.value;
    if(!name || !password){
      alert('Por favor, preencha nome e senha.');
      return;
    }
    startScreen.style.display = 'none';
    loginScreen.style.display = 'none';
    gameContainer.style.display = 'flex';
    gameContainer.setAttribute('aria-hidden', 'false');
    
    gameState.username = name;
    if(gender === 'masculino'){
      gameState.playerSkinImg = characterImgMale;
    } else {
      gameState.playerSkinImg = characterImgFemale;
    }
    
    gameState.playerPos = playerInitialPos;
    
    // Gera estoque inicial da loja
    generateShopStock();
    
    updateUI();
    draw();
    addSaveLoadButtons();
    setupMobileControls();
    
    // Configura posições iniciais dos pets
    petPositions = {
      cat: { x: Math.max(0, gameState.playerPos.x -1), y: gameState.playerPos.y },
      raccoon: { x: Math.max(0, gameState.playerPos.x -2), y: gameState.playerPos.y },
      bee: { x: Math.max(0, gameState.playerPos.x -3), y: gameState.playerPos.y }
    };
    
    // Move pets aleatoriamente a cada 2 segundos
    setInterval(() => {
      movePetsRandomly();
      draw();
    }, 2000);
    
    // Tocar música
    const playPromise = gameOst.play();
    if(playPromise !== undefined){
      playPromise.catch(() => {});
    }
  });

  // Mobile Detection and Controls Implementation
  function isMobileDevice() {
    return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent) 
      || ('maxTouchPoints' in navigator && navigator.maxTouchPoints > 1);
  }

  function setupMobileControls(){
    if(!isMobileDevice()) return;

    mobileControls.style.display = 'flex';

    // Controles de direção
    document.getElementById('btn-up').addEventListener('touchstart', (e) => {
      movePlayer(0, -1);
      e.preventDefault();
    }, {passive: false});
    
    document.getElementById('btn-down').addEventListener('touchstart', (e) => {
      movePlayer(0, 1);
      e.preventDefault();
    }, {passive: false});
    
    document.getElementById('btn-left').addEventListener('touchstart', (e) => {
      movePlayer(-1, 0);
      e.preventDefault();
    }, {passive: false});
    
    document.getElementById('btn-right').addEventListener('touchstart', (e) => {
      movePlayer(1, 0);
      e.preventDefault();
    }, {passive: false});

    // Botões de ação
    document.getElementById('btn-plant').addEventListener('click', (e) => {
      plantSeedFromInventory();
      e.preventDefault();
    });
    
    document.getElementById('btn-harvest').addEventListener('click', (e) => {
      harvestPlants();
      e.preventDefault();
    });
    
    document.getElementById('btn-shop-fruits').addEventListener('click', (e) => {
      openShopFruits();
      e.preventDefault();
    });
    
    document.getElementById('btn-shop-seeds').addEventListener('click', (e) => {
      openShopSeeds();
      e.preventDefault();
    });

    // Melhor feedback visual
    const buttons = document.querySelectorAll('.mobile-btn');
    buttons.forEach(btn => {
      btn.addEventListener('touchstart', () => {
        btn.style.transform = 'scale(0.95)';
        btn.style.opacity = '0.8';
      });
      
      btn.addEventListener('touchend', () => {
        btn.style.transform = '';
        btn.style.opacity = '';
      });
    });
  }

  // Shop helper functions
  function isNear(pos1, pos2){
    const dx = Math.abs(pos1.x - pos2.x);
    const dy = Math.abs(pos1.y - pos2.y);
    return (dx <= 1 && dy <= 1);
  }
});
</script>
</body>
</html>